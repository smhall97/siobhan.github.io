#!/bin/bash
# Claude Code Pre-Commit Hook
# Prevents direct commits to main, but allows merge commits for deployment

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [ "$CURRENT_BRANCH" = "main" ]; then
  # Check if this is a merge commit
  if [ -f .git/MERGE_HEAD ]; then
    # This is a merge commit - allow it (for deployment)
    echo "✓ Merge commit to main allowed (deployment workflow)"
    exit 0
  fi

  # This is a direct commit to main - block it
  echo ""
  echo "❌ ERROR: You are attempting to commit directly to the main branch"
  echo ""
  echo "The main branch is production-only and auto-deploys to GitHub Pages."
  echo "ALL development work must happen on the dev branch."
  echo ""
  echo "To fix this:"
  echo "  1. Switch to dev branch: git checkout dev"
  echo "  2. Make your commit on dev instead"
  echo ""
  echo "To deploy to production:"
  echo "  1. Ensure dev has your changes: git checkout dev && git status"
  echo "  2. Merge to main: git checkout main && git merge dev"
  echo "  3. Push to deploy: git push origin main"
  echo "  4. Return to dev: git checkout dev"
  echo ""
  exit 1
fi

if [ "$CURRENT_BRANCH" != "dev" ]; then
  echo ""
  echo "⚠️  WARNING: You are on branch '$CURRENT_BRANCH'"
  echo "Expected branch: dev"
  echo ""
  echo "Do you want to continue committing to '$CURRENT_BRANCH'? (y/n)"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    echo "Commit cancelled. Switch to dev branch with: git checkout dev"
    exit 1
  fi
fi

# Allow commit to proceed
exit 0
